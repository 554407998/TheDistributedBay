"use strict";angular.module("theDistributedBayApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$locationProvider","$compileProvider",function(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/browse",{templateUrl:"views/browse.html",controller:"BrowseCtrl"}).when("/recent",{templateUrl:"views/recent.html",controller:"RecentCtrl"}).when("/torrent/add",{templateUrl:"views/torrent/add.html",controller:"TorrentAddCtrl"}).when("/search",{templateUrl:"views/search.html",controller:"SearchCtrl",reloadOnSearch:!1}).when("/torrent/:hash/?:name?",{templateUrl:"views/torrent/view.html",controller:"TorrentViewCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|magnet):/)}]),angular.module("theDistributedBayApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").controller("BrowseCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").controller("RecentCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").directive("torrentDisplay",["helpers",function(a){return{templateUrl:"views/torrent-display.html",restrict:"E",controller:["$scope","$location",function(b,c){b.headers=["Age","Size","Seeders","Leechers"],b.sanitize=a.sanitizeName,b.sort=c.search().sort,b.sortBy=function(a){b.sort=a},b.$watch("torrents",function(){_.each(b.torrents,function(a){a.TimeAgo=moment(a.CreatedAt).fromNow()})})}]}}]),angular.module("theDistributedBayApp").service("data",["$http","$q",function(a,b){var c;this.search=function(d){c&&c.resolve(),d=_.merge({q:""},d);var e=_.map(d,function(a,b){return b+"="+a}).join("&"),f=b.defer();return c=b.defer(),a.get("/api/search?"+e,{timeout:c.promise,cache:!0}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},this.getTorrent=function(c){var d=b.defer();return a.get("/api/torrent?hash="+escape(c),{cache:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},this.addTorrent=function(b){b=_.merge({MagnetLink:"magnet:",Name:"",Description:"",CategoryID:0,CreatedAt:new Date,Tags:[]},b),console.log("ADD TORRENT",b),a.post("/api/add_torrent",b).success(function(a){console.log("ADDED",a)}).error(function(a){alert("Error! ",a)})}}]),angular.module("theDistributedBayApp").controller("TorrentAddCtrl",["$scope","data",function(a,b){a.addTorrent=function(){b.addTorrent({MagnetLink:a.magnet,Name:a.name,Description:a.description,Tags:_.map(a.tags.split(","),function(a){return a.trim()})})}}]),angular.module("theDistributedBayApp").controller("SearchCtrl",["$scope","data","$location",function(a,b,c){function d(a){var b=_.clone(c.search());return 0===a?delete b.p:b.p=a,c.path()+"?"+_.map(b,function(a,b){return b+"="+a}).join("&")}function e(){return parseInt(c.search().p||0,10)}a.currentSearchWithSort=function(a){var b=_.clone(c.search());return b.sort=a,delete b.p,c.path()+"?"+_.map(b,function(a,b){return b+"="+a}).join("&")},a.pages=0,a.page=e(),a.$watch("query",function(){a.page=0}),a.$on("$routeUpdate",function(){var b=c.search();a.page=e(),a.query=b.q,window.scrollTo(window.scrollX,0)}),a.$watchGroup(["query","page","category"],function(){a.loading=!0;b.search({q:a.query,p:c.search().p,category:c.search().category}).then(function(b){console.log("Search results",b),a.torrents=b.Torrents,a.pages=b.Pages,a.page>=a.pages&&(a.page=0),a.jumpLinks=_.mapValues({start:0,prev:Math.max(a.page-1,0),next:Math.min(a.page+1,a.pages-1),end:a.pages-1},d);var c=e(),f=Math.max(c-5,0),g=Math.min(c+5,a.pages-1);a.pageLinks=[];var h;for(h=f;g>=h;h++)a.pageLinks.push({link:d(h),page:h+1,active:h===c});a.loading=!1},function(a){console.log("SEARCH ERR",a)})})}]),angular.module("theDistributedBayApp").directive("searchForm",function(){return{templateUrl:"views/search-form.html",restrict:"E",controller:["$scope","$rootScope","$location",function(a,b,c){function d(){var b=c.search();b.category=_.reduce(a.categories,function(a,b){return b.checked?a.concat(b.name):a},[]).join(","),(""===b.category||"All"===b.category)&&delete b.category,a.category=b.category,a.query?("/search"!==c.path()&&c.path("/search"),b.q=a.query,0!==parseInt(a.page,10)?b.p=a.page:delete b.p):delete b.q,c.search(b)}function e(b,d){console.log(b,d),b!==d&&(delete c.search().p,a.page=0)}a.categories=[{name:"All",checked:!1},{name:"Anime",checked:!1},{name:"Software",checked:!1},{name:"Games",checked:!1},{name:"Adult",checked:!1},{name:"Movies",checked:!1},{name:"Music",checked:!1},{name:"Other",checked:!1},{name:"Series & TV",checked:!1},{name:"Books",checked:!1}],a.query=c.search().q,a.page=c.search().p||0;var f=c.search().category;f&&_.each(f.split(","),function(b){_.each(a.categories,function(a){b===a.name&&(a.checked=!0)})}),a.$watch("query",e),a.$watch("category",e),a.search=d,a.searchLucky=d,a.$watchGroup(["query","page"],function(){d()}),b.$on("$routeChangeSuccess",function(a,b,c){"/"===b.originalPath?($(".form-small").removeClass("form-small").addClass("form-big"),$(".index-wrapper .index:not(.container)").addClass("container")):c&&"/"===c.originalPath&&($(".form-big").removeClass("form-big").addClass("form-small"),$(".index-wrapper .index.container").removeClass("container"))}),a.checked=function(b){var c=_.reduce(a.categories,function(a,b){return a+b.checked},0);"All"===b.name?_.each(a.categories.slice(1),function(a){a.checked=!1}):a.categories[0].checked=!1,0===c&&(a.categories[0].checked=!0),d()},a.checked(a.categories[1])}]}}),angular.module("theDistributedBayApp").controller("TorrentViewCtrl",["$scope","$routeParams","data","helpers",function(a,b,c,d){a.sanitize=d.sanitizeName,c.getTorrent(b.hash).then(function(b){a.torrent=b},function(a){alert("Not found:",a)})}]),angular.module("theDistributedBayApp").service("helpers",function(){this.sanitizeName=function(a){return(a||"").replace(/\W+/g,"-")}});