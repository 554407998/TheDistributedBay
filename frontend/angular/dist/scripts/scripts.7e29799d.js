"use strict";angular.module("theDistributedBayApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$locationProvider","$compileProvider",function(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/browse",{templateUrl:"views/browse.html",controller:"BrowseCtrl"}).when("/recent",{templateUrl:"views/recent.html",controller:"RecentCtrl"}).when("/torrent/add",{templateUrl:"views/torrent/add.html",controller:"TorrentAddCtrl"}).when("/search",{templateUrl:"views/search.html",controller:"SearchCtrl",reloadOnSearch:!1}).when("/torrent/:hash/?:name?",{templateUrl:"views/torrent/view.html",controller:"TorrentViewCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|magnet):/)}]),angular.module("theDistributedBayApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").controller("BrowseCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("theDistributedBayApp").directive("torrentDisplay",["helpers",function(){return{templateUrl:"views/torrent-display.html",restrict:"E",controller:["$scope","$location","helpers",function(a,b,c){a.headers=["Age","Size","Seeders","Leechers"],a.sanitize=c.sanitizeName;var d=(b.search().sort||"").split(":");a.sort=d[0],a.sortDir=d[1]||"desc",a.$watch("torrents",function(){_.each(a.torrents,function(a){a.TimeAgo=moment(a.CreatedAt).fromNow()})}),a.humanFileSize=c.humanFileSize,a.currentSearchWithSort=c.currentSearchWithSort,a.updateJumpLinks=function(){a.page>=a.pages&&(a.page=0);var b=c.currentPage();a.jumpLinks=_.mapValues({start:0,prev:Math.max(b-1,0),next:Math.min(b+1,a.pages-1),end:a.pages-1},c.currentSearchWithPage);var d=Math.max(b-5,0),e=Math.min(b+5,a.pages-1);a.pageLinks=[];var f;for(f=d;e>=f;f++)a.pageLinks.push({link:c.currentSearchWithPage(f),page:f+1,active:f===b})},a.updateJumpLinks(),a.$watch("torrents",a.updateJumpLinks)}]}}]),angular.module("theDistributedBayApp").service("data",["$http","$q","helpers",function(a,b,c){var d;this.search=function(e){d&&d.resolve(),e=_.merge({q:""},e),e=c.removeEmpty(e);var f=_.map(e,function(a,b){return b+"="+a}).join("&"),g=b.defer();return d=b.defer(),a.get("/api/search?"+f,{timeout:d.promise,cache:!0}).success(function(a){g.resolve(a)}).error(function(a){g.reject(a)}),g.promise},this.getTorrent=function(c){var d=b.defer();return a.get("/api/torrent?hash="+escape(c),{cache:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},this.addTorrent=function(b){b=_.merge({MagnetLink:"magnet:",Name:"",Description:"",CategoryID:0,CreatedAt:new Date,Tags:[]},b),a.post("/api/add_torrent",b).success(function(a){console.log("ADDED",a)}).error(function(a){alert("Error! ",a)})}}]),angular.module("theDistributedBayApp").controller("TorrentAddCtrl",["$scope","data",function(a,b){a.addTorrent=function(){b.addTorrent({MagnetLink:a.magnet,Name:a.name,Description:a.description,CategoryID:parseInt(a.category,10),Tags:_.map(a.tags.split(","),function(a){return a.trim()})})}}]),angular.module("theDistributedBayApp").controller("SearchCtrl",["$scope","data","$location","helpers",function(a,b,c,d){a.isRecent=d.isRecent,a.pages=0,a.page=d.currentPage(),a.$watch("query",function(){a.page=0}),a.$on("$routeUpdate",function(){var b=c.search();a.query=b.q,a.page=d.currentPage();var e=(c.search().sort||"").split(":");a.sort=e[0],a.sortDir=e[1]||"desc",window.scrollTo(window.scrollX,0)}),a.$watchGroup(["query","page","category","sort","sortDir"],function(){a.loading=!0;var d="";console.log(a.sort,c.search()),a.sort&&(d=(a.sort.replace(/Age/g,"CreatedAt")+":"+a.sortDir).replace(/Seeders:/g,"Seeders.Min:").replace(/Leechers:/g,"Leechers.Min:").replace(/Completed:/g,"Completed.Min:")),b.search({q:a.query||"",p:c.search().p||"",sort:d,category:c.search().category}).then(function(b){console.log("Search results",b),a.torrents=b.Torrents,a.pages=b.Pages,a.loading=!1},function(a){console.log("SEARCH ERR",a)})})}]),angular.module("theDistributedBayApp").directive("searchForm",function(){return{templateUrl:"views/search-form.html",restrict:"E",controller:["$scope","$rootScope","$location","helpers",function(a,b,c,d){function e(){var b=c.search();b.category=_.reduce(a.categories,function(a,b){return b.checked?a.concat(b.name):a},[]).join(","),(""===b.category||"All"===b.category)&&delete b.category,a.category=b.category,a.query?("/search"!==c.path()&&c.path("/search"),b.q=a.query,0!==parseInt(a.page,10)?b.p=a.page:delete b.p):delete b.q,c.search(b)}function f(b,d){b!==d&&(delete c.search().p,a.page=0)}a.categories=[{name:"All",checked:!1},{name:"Anime",checked:!1},{name:"Software",checked:!1},{name:"Games",checked:!1},{name:"Adult",checked:!1},{name:"Movies",checked:!1},{name:"Music",checked:!1},{name:"Other",checked:!1},{name:"Series & TV",checked:!1},{name:"Books",checked:!1}],a.query=c.search().q,a.page=c.search().p||0;var g=c.search().category;g&&_.each(g.split(","),function(b){_.each(a.categories,function(a){b===a.name&&(a.checked=!0)})}),a.$watch("query",f),a.$watch("category",f),a.search=e,a.searchLucky=e,a.$watchGroup(["query","page"],function(){e()}),b.$on("$routeChangeSuccess",function(a,b,c){"/"===b.originalPath?($(".form-small").removeClass("form-small").addClass("form-big"),$(".index-wrapper .index:not(.container)").addClass("container")):c&&"/"===c.originalPath&&($(".form-big").removeClass("form-big").addClass("form-small"),$(".index-wrapper .index.container").removeClass("container"))}),a.checked=function(b){var c=_.reduce(a.categories,function(a,b){return a+b.checked},0);"All"===b.name?_.each(a.categories.slice(1),function(a){a.checked=!1}):a.categories[0].checked=!1,0===c&&(a.categories[0].checked=!0),e()},a.checked(a.categories[1]),a.isRecent=d.isRecent,a.isSearch=function(){return!d.isRecent()&&"/search"===c.path()},a.isBrowse=function(){return"/browse"===c.path()}}]}}),angular.module("theDistributedBayApp").controller("TorrentViewCtrl",["$scope","$routeParams","data","helpers",function(a,b,c,d){a.sanitize=d.sanitizeName,a.humanFileSize=d.humanFileSize,c.getTorrent(b.hash).then(function(b){console.log("TORRENT",b),a.torrent=b},function(a){alert("Not found:",a)})}]),angular.module("theDistributedBayApp").service("helpers",["$location",function(a){this.removeEmpty=function(a){var b=_.clone(a);return _.each(b,function(a,c){(void 0===a||""===a)&&delete b[c]}),b},this.sanitizeName=function(a){return(a||"").replace(/\W+/g,"-")},this.humanFileSize=function(a,b){var c=b?1e3:1024;if(c>a)return a+" B";var d=b?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],e=-1;do a/=c,++e;while(a>=c);return a.toFixed(1)+" "+d[e]},this.currentSearchWithPage=function(b){var c=_.clone(a.search());return 0===b?delete c.p:c.p=b,a.path()+"?"+_.map(c,function(a,b){return b+"="+a}).join("&")},this.currentSearchWithSort=function(b,c,d){var e="desc";b===c&&(e="desc"===d?"asc":"desc");var f=_.clone(a.search());return f.sort=b+":"+e,delete f.p,a.path()+"?"+_.map(f,function(a,b){return b+"="+a}).join("&")},this.currentPage=function(){return parseInt(a.search().p||0,10)},this.isRecent=function(){return"/search"===a.path()&&_.isEqual(a.search(),{sort:"Age:desc"})}}]);